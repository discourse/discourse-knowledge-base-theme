<script type="text/discourse-plugin" version="0.8">
  const computed = require("ember-addons/ember-computed-decorators").default;
  const on = require("ember-addons/ember-computed-decorators").on;
  const observes = require("ember-addons/ember-computed-decorators").observes;

  const helper = {
    arrayContainsArray (superset, subset) {
      if (0 === subset.length) {
        return false;
      }
      return subset.every(function (value) {
        return (superset.indexOf(value) >= 0);
      });
    }
  };

  api.addDiscoveryQueryParam("tags", { replace: true, refreshModel: true });

  api.modifyClass("component:bread-crumbs", {
    kbHelper: Ember.inject.service(),

    @computed("kbHelper.active")
    kbActive(active) {
      return active;
    }
  });

  api.modifyClass("component:d-navigation", {
    kbHelper: Ember.inject.service(),

    @computed("kbHelper.active")
    kbActive(active) {
      return active;
    }
  });

  api.modifyClass("controller:discovery/topics", {

    kbHelper: Ember.inject.service(),
    filteredList: null,

    @on("init")
    @observes("model")
    modelChange() {
      this.kbHelper.updateCurrentDiscoveryModel(this.model);
    },

    @on("init")
    @observes("category")
    changeCategory() {
      this.kbHelper.updateCurrentCategory(this.category);
    },
    @computed("kbHelper.active")
    kbActive(active) {
      return active;
    },

    @observes("model")
    kbFilterTopics(){
     const model = this.get("model");
     let tagsFilter = this.kbHelper.kbParams();
     if (tagsFilter) {
       tagsFilter = tagsFilter.split(" ");
       model.topics = model.topics.filter((topic) => {
        let tags = topic.tags;

        return helper.arrayContainsArray(tags, tagsFilter);

       });
     }


     this.set("model", model);
     
    },

  });

  Discourse.register("service:kb-helper", Ember.Service.extend({
  
    router: Ember.inject.service(),

    updateCurrentDiscoveryModel(model) {
      if (model) {
        this.set("discoveryParams", model.params);
        this.set("discoveryTopTags", model.get("topic_list.top_tags"));
      }
    },

    updateCurrentCategory(category) {
      this.set("discoveryCategory", category);
    },

    hrefForTag(category, tagName) {
      let destinationURL = "";
      if (category && tagName) {
        const slug = Discourse.Category.slugFor(category);
        let tagsParam = this.kbParams();

        if (tagsParam) { //if existing params
          if (tagsParam.includes(tagName)) { // removing a param

            tagsParam = tagsParam.replace(tagName, '');
            tagsParam = tagsParam.replace(/^\s+|\s+$/g, '');

            if (tagsParam === "") { // if no params, send base category URL
              destinationURL = `/c/${slug}?tags=`;
            }
            else {
              destinationURL = `/c/${slug}?tags=${tagsParam}`; // send URL with removed params
            }
          }
          else { //if adding new param
            destinationURL = `/c/${slug}?tags=${tagsParam} ${tagName}`; 
          }
        }
        else { //if no existing params
          destinationURL = `/c/${slug}?tags=${tagName}`;
        }
      }
      return destinationURL;
    },

    kbParams(){
      const params = window.location.search;
      if (params) {
        let tagsParam = params.match(/tags=([^&]*)/)[1];
        tagsParam = decodeURIComponent(tagsParam);
        return tagsParam
      }

      return false;
    },

    @computed("discoveryCategory")
    active(category) {
      const siteSettings = api.container.lookup("site-settings:main");
      const kbCategories = settings.kb_categories.split("|").filter(n => n);
      const tagsEnabled = siteSettings.tagging_enabled;
      const tagFilterEnabled = siteSettings.show_filter_by_tag;

      if (kbCategories.length === 0) {
        return false;
      }
      else if (!tagsEnabled || !tagFilterEnabled) {
        console.log("Knowledge Base Theme Component requires the following site settings to be enabled: `tagging_enabled` and `show_filter_by_tag`");
        return false;
      }
      if (category) {
        return kbCategories.includes(category.slug);
      }
      return false;
      
    },
    @on("init")
    @observes("active")
    updateClasses() {
      if (this.active) {
        document.body.classList.add("kb-active");
      } else {
        document.body.classList.remove("kb-active");
      }
    },
  
  }));

</script>

